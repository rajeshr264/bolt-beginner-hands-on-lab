# Setting up test nodes and Bolt setup

## Bring up 4 test nodes using Vagrant

> **Time**: Approximately 20 minutes

In this exercise you will create nodes that you can use to experiment with Bolt. The attached Vagrantfile configures two CentOS-7 nodes and two Windows 2016 nodes.

1. Just for your information, open the `Vagrantfile` in this directory. It will show the 2 linux (_linux-1_ and _linux-2_) and 2 windows nodes (_win-1_ and _win-2_) being brought up.
1. Bring up the 4 test nodes:  `vagrant up --provider=virtualbox`
1. The previous step will take quite some time, especially downloading Windows 2016 Vagrant box. You will need a good internet connection.
1. Confirm the status of the 4 VMs are up using vagrant: `bolt-beginner-hands-on-lab/02-acquiring-nodes > vagrant status`

> Current machine states:
> linux-1                     running (virtualbox)
> linux-2                     running (virtualbox)
> win-1                       running (virtualbox)
> win-2                       running (virtualbox)

## Bolt setup

### Project Directory: Boltdir, creating a bolt.yaml file

Bolt runs in the context of a Bolt project directory called a *boltdir*. Any directory containing a __bolt.yaml__ file becomes a boltdir.

Note the __bolt-beginner-hands-on-lab/bolt.yaml__ file in the root directory of this lab. You will be _copying this bolt.yaml file to every lab_ that you will be doing.

### Building the inventory.yaml file

To connect to a bunch of machines, you can sometimes specify all the credentials, node names etc, on the Bolt command line. However, the better way is to specify all this information in an __inventory.yaml__ file. 

Note the __bolt-beginner-hands-on-lab/inventory.yaml__ file in the root directory of this lab. You will editing inventory.yaml file and then _copying this inventory.yaml file to every lab_ that you will be doing.

#### Editing the Linux nodes part of the inventory.yaml file

1. `vagrant` has the Linux node information we need. Type:

    ```
    02-acquiring-nodes>  vagrant ssh-config > config.txt
    ```

2. Open the inventory.yaml file in your favorite editor. My favorite editor is [Visual Studio Code](https://code.visualstudio.com/download)!
3. Open the generated `02-acquiring-nodes/config.txt` file generated by `vagrant`.
4. You need to locate the section for `linux-1` in the `config.txt` file and in the `inventory.yaml` file.
5. Locate the `Port` and `IdentityFile` values in the `config.txt` file .   
5. Add the value from the `Port` entry and replace it in `<add port number for linux-1 forwarded SSH port number 22>` in the `inventory.yaml` file.
6. Add the value from the `IdentityFile` entry and replace it in `<add IdentityFile value for linux-1 from config.txt file>` in the `inventory.yaml` file.
7. Repeat for `linux-2`.

#### Editing the Windows nodes part of the inventory.yaml file

1. Type: `vagrant port win-1`. 
2. From the output, note the line that shows how the WinRM port 5895 running in the Guest VM, is forwarded to the host (your laptop) machine.
3. Find this line :
```
win-1: 5895 (guest) => 55985 (host)
```
4. The forwarded port value i.e `55985`, is the value that goes into the `<add port number for win-1 forwarded WinRM port number 5895>` in the `inventory.yaml` file.
5. Repeat for `win-2` node.

## Managing the nodes with Vagrant

### Suspend
If you are done with the above steps and want to continue with the next labs steps later, you can suspend the VMs. 
Type : 
```
bolt-beginner-hands-on-lab/02-acquiring-nodes > vagrant suspend
```
### Resume
To resume the VMs, type:
```
bolt-beginner-hands-on-lab/02-acquiring-nodes > vagrant resume
```

### Destroy
To delete all the VMs, type:
```
bolt-beginner-hands-on-lab/02-acquiring-nodes > vagrant destroy -f
```
### To start all over again
To restart all over again, type:
```
bolt-beginner-hands-on-lab/02-acquiring-nodes > vagrant up --provider=virtualbox
```

# Sample inventory.yaml file

bolt-beginner-hands-on-lab/inventory.yaml 
```
groups:
  - name: linux_nodes
    groups:
      - name: linux-1
        nodes:
          - localhost:2200 # 'Port' value from linux-1 section, from config.txt
        config:
          ssh:
            user: vagrant
            private-key:/Users/foo/bolt-beginner-hands-on-lab/02-acquiring-nodes/.vagrant/machines/linux-1/virtualbox/private_key # 'IdentityFile' value for linux-1
            host-key-check: false
      - name: linux-2
        nodes:
          - localhost:2201 # 'Port' value from linux-2 section, from config.txt
        config:
          ssh:
            user: vagrant
            private-key:/Users/foo/bolt-beginner-hands-on-lab/02-acquiring-nodes/.vagrant/machines/linux-2/virtualbox/private_key # 'IdentityFile' value for linux-2
            host-key-check: false
  - name: win_nodes
    groups:
      - name: windows
        nodes:
          - localhost:55985  # From 'vagrant port win-1', forwarded port 5895 => 55985
          - localhost:2204   # From 'vagrant port win-2', forwarded port 5895 => 2204
    config:
      transport: winrm
      winrm:
        user: vagrant
        password: vagrant
        ssl: false
```

# Next steps

Resume or start up the test nodes and you can move on to next lab:

[Running Commands](../03-running-commands)
